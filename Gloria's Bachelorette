<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gloriaâ€™s Bachelorette â€” El Ãšltimo Pintxo</title>
  <style>
    :root{
      --pink:#f6d7df;
      --pink2:#fbe7ec;
      --bottle:#1f4f3c;
      --bottle2:#2e6a52;
      --cream:#fff7f9;
      --ink:#17392c;
      --shadow: 0 10px 25px rgba(0,0,0,.12);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1000px 500px at 20% 10%, var(--pink2), transparent 70%),
        radial-gradient(900px 600px at 90% 30%, #f3c8d4, transparent 70%),
        linear-gradient(180deg, var(--pink), #f0c9d4 55%, #f7dde4);
      color:#10261d;
    }
    header{
      padding: 20px 16px 10px;
      text-align:center;
    }
    .badge{
      display:inline-block;
      padding:6px 12px;
      border:2px solid var(--bottle);
      border-radius:999px;
      color:var(--bottle);
      background:rgba(255,255,255,.55);
      font-weight:700;
      letter-spacing:.3px;
      margin-bottom:10px;
    }
    h1{
      margin:8px 0 6px;
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      color:var(--bottle);
      font-size: 34px;
      line-height:1.05;
    }
    .subtitle{
      margin:0;
      font-weight:650;
      color: var(--ink);
      opacity:.9;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 14px 60px;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin: 14px 0 16px;
    }
    .tabbtn{
      border:2px solid var(--bottle);
      background: rgba(255,255,255,.65);
      color: var(--bottle);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:800;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      transition: transform .08s ease, background .2s ease;
      user-select:none;
    }
    .tabbtn:active{ transform: scale(.98); }
    .tabbtn.active{
      background: var(--bottle);
      color: var(--cream);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(255,255,255,.72);
      border: 2px solid rgba(31,79,60,.25);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      position: relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(circle at 10px 10px, rgba(31,79,60,.22) 2px, transparent 3px) 0 0/26px 26px;
      opacity:.25;
      pointer-events:none;
    }
    .card > *{ position:relative; }

    .h2{
      margin: 2px 0 10px;
      color: var(--bottle);
      font-size: 18px;
      letter-spacing:.2px;
      font-weight:900;
    }
    .muted{ color:#1a3a2c; opacity:.75; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    button.primary{
      background: var(--bottle);
      color: var(--cream);
      border: 0;
      padding: 11px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:900;
      box-shadow: 0 8px 16px rgba(31,79,60,.25);
      transition: transform .08s ease, filter .15s ease;
    }
    button.primary:active{ transform: scale(.98); }
    button.ghost{
      background: rgba(255,255,255,.7);
      border: 2px solid var(--bottle);
      color: var(--bottle);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:900;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(31,79,60,.10);
      border:1px solid rgba(31,79,60,.22);
      color: var(--bottle);
      font-weight:800;
      font-size: 13px;
    }

    .big{
      font-size: 22px;
      line-height:1.25;
      font-weight:900;
      color: #133126;
      margin: 6px 0 10px;
    }
    .box{
      background: rgba(246,215,223,.35);
      border: 2px dashed rgba(31,79,60,.35);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }

    .choices{ display:grid; gap:10px; margin-top:10px; }
    .choice{
      text-align:left;
      padding: 10px 12px;
      border-radius: 14px;
      border:2px solid rgba(31,79,60,.25);
      background: rgba(255,255,255,.65);
      cursor:pointer;
      font-weight:850;
      color:#17392c;
    }
    .choice:hover{ border-color: rgba(31,79,60,.55); }
    .choice.correct{ border-color: rgba(46,106,82,.95); background: rgba(46,106,82,.10); }
    .choice.wrong{ border-color: rgba(170,40,70,.8); background: rgba(170,40,70,.08); }

    .divider{
      height:1px;
      background: rgba(31,79,60,.20);
      margin: 10px 0;
    }
    .small{ font-size: 13px; }

    .hidden{ display:none !important; }
    a{ color: var(--bottle); font-weight:800; text-decoration:none; }
  </style>
</head>

<body>
<header>
  <div class="badge">#TeamBride Â· 13â€“15 marÃ§ Â· LogroÃ±o</div>
  <h1>Â¡El Ãšltimo Pintxo!</h1>
  <p class="subtitle">Juego de despedida Â· Rosa + verde botella Â· FrangÃ©lico mode: ON</p>
</header>

<div class="wrap">
  <div class="tabs" id="tabs">
    <div class="tabbtn active" data-tab="cartas">ğŸ´ Cartas</div>
    <div class="tabbtn" data-tab="quiz">ğŸ’˜ Quiz del novio</div>
    <div class="tabbtn" data-tab="frangelico">ğŸ² FrangÃ©lico decide</div>
    <div class="tabbtn" data-tab="pasapalabra">â±ï¸ Pasapalabra</div>
    <div class="tabbtn" data-tab="ajustes">âš™ï¸ Ajustes</div>
  </div>

  <!-- CARTAS -->
  <section class="grid" id="tab-cartas">
    <div class="card">
      <div class="h2">ğŸ´ Cartas de pruebas / preguntas</div>
      <div class="row">
        <span class="pill" id="deckInfo">Mazo: 0 cartas</span>
        <span class="pill" id="repeatInfo">No repetir: ON</span>
        <span class="pill" id="alcoholInfo">Alcohol: ON</span>
      </div>

      <div class="box">
        <div class="muted small">Pulsa para sacar una carta. Si â€œno repetirâ€ estÃ¡ activado, no saldrÃ¡ la misma hasta agotar el mazo.</div>
        <div class="big" id="cardText">Lista para la primera carta âœ¨</div>
        <div class="row">
          <span class="pill" id="cardTag">â€”</span>
          <span class="pill" id="cardType">â€”</span>
          <span class="pill" id="cardDrink">â€”</span>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="primary" id="drawCardBtn">Sacar carta</button>
        <button class="ghost" id="undoCardBtn">Deshacer</button>
        <button class="ghost" id="resetDeckBtn">Reset mazo</button>
      </div>

      <div class="divider"></div>
      <div class="muted small">
        Truco: puedes usar cartas â€œSuave/Medio/CaÃ³ticoâ€ con pesos distintos (ver Ajustes).
      </div>
    </div>

    <div class="card">
      <div class="h2">ğŸ“œ Historial</div>
      <div class="muted small">Para acordarse maÃ±ana (o para negociar ğŸ˜‡).</div>
      <div id="history" class="small" style="margin-top:10px; display:grid; gap:8px;"></div>
      <div class="divider"></div>
      <button class="ghost" id="clearHistoryBtn">Borrar historial</button>
    </div>
  </section>

  <!-- QUIZ -->
  <section class="grid hidden" id="tab-quiz">
    <div class="card">
      <div class="h2">ğŸ’˜ Quiz del novio (con respuestas ya fijadas)</div>
      <div class="row">
        <span class="pill" id="quizProgress">Pregunta 0/0</span>
        <span class="pill" id="quizScore">Aciertos: 0</span>
        <span class="pill" id="quizModeInfo">Probabilidad: ON</span>
      </div>

      <div class="box">
        <div class="muted small">Responde sin mirar la clave. Al final calculamos la probabilidad de â€œcastigoâ€ segÃºn aciertos.</div>
        <div class="big" id="quizQ">Pulsa â€œEmpezarâ€</div>
        <div class="choices" id="quizChoices"></div>
        <div class="divider"></div>
        <div id="quizFeedback" class="small muted"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="primary" id="quizStartBtn">Empezar</button>
        <button class="ghost" id="quizNextBtn" disabled>Siguiente</button>
        <button class="ghost" id="quizResetBtn">Reset</button>
      </div>
    </div>

    <div class="card">
      <div class="h2">ğŸ¯ Resultado y â€œÂ¿toca?â€</div>
      <div class="muted small">Probabilidad depende de aciertos. Puedes activar â€œsin alcoholâ€ en Ajustes.</div>

      <div class="box">
        <div class="big" id="quizResult">AÃºn no hay resultado.</div>
        <div class="row">
          <span class="pill" id="pMinMax">pmin â€” / pmax â€”</span>
          <span class="pill" id="pNow">p â€”</span>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="primary" id="rollPunishBtn">Tirar â€œÂ¿toca?â€</button>
        <button class="ghost" id="revealAnswersBtn">Ver clave del novio</button>
      </div>

      <div class="divider"></div>
      <div id="answerKey" class="small muted hidden"></div>
    </div>
  </section>

  <!-- FRANGELICO -->
  <section class="grid hidden" id="tab-frangelico">
    <div class="card">
      <div class="h2">ğŸ² El FrangÃ©lico decide</div>
      <div class="row">
        <span class="pill" id="frUses">Usos: 0/3</span>
        <span class="pill" id="frNoAlcohol">Modo sin alcohol: OFF</span>
      </div>

      <div class="box">
        <div class="muted small">Regla sugerida: mÃ¡ximo 3 usos en todo el finde (editable en Ajustes).</div>
        <div class="big" id="frText">Â¿Nos dejamos llevarâ€¦?</div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="primary" id="frRollBtn">FrangÃ©lico decide</button>
        <button class="ghost" id="frResetBtn">Reset contador</button>
      </div>
    </div>

    <div class="card">
      <div class="h2">ğŸ§¾ Reglas rÃ¡pidas</div>
      <ul class="small" style="margin:0; padding-left:18px; color:#17392c">
        <li>Si sale â€œchupitoâ€ y estÃ¡ activado â€œsin alcoholâ€ â†’ cambia por â€œreto rÃ¡pidoâ€.</li>
        <li>Si os estÃ¡is viniendo arriba demasiado pronto â†’ activad â€œSuaveâ€.</li>
        <li>Objetivo: risa + fotos bonitas (con permiso ğŸ˜Œ).</li>
      </ul>
    </div>
  </section>

  <!-- PASAPALABRA -->
  <section class="grid hidden" id="tab-pasapalabra">
    <div class="card">
      <div class="h2">â±ï¸ Pasapalabra</div>
      <div class="row">
        <span class="pill" id="ppTimer">Tiempo: 90s</span>
        <span class="pill" id="ppIndex">Letra: A</span>
      </div>

      <div class="box">
        <div class="muted small">Pulsa â€œStartâ€ y ve pasando letras. Si falla/â€œpasaâ€, sorbo (o reto light).</div>
        <div class="big" id="ppClue">â€”</div>
        <div class="divider"></div>
        <div class="row">
          <button class="primary" id="ppStartBtn">Start</button>
          <button class="ghost" id="ppPassBtn" disabled>Pasa</button>
          <button class="ghost" id="ppShowBtn" disabled>Mostrar palabra</button>
          <button class="ghost" id="ppResetBtn">Reset</button>
        </div>
        <div id="ppWord" class="small muted" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="card">
      <div class="h2">ğŸ“Œ Marcador (simple)</div>
      <div class="muted small">Puedes usarlo â€œa ojoâ€ o llevar recuento.</div>
      <div class="box">
        <div class="row">
          <span class="pill" id="ppPassed">Pasadas: 0</span>
          <span class="pill" id="ppShown">Reveladas: 0</span>
        </div>
        <div class="divider"></div>
        <div class="small muted">Sugerencia: por cada 3 reveladas, mini-castigo o reto (sin alcohol si querÃ©is).</div>
      </div>
    </div>
  </section>

  <!-- AJUSTES -->
  <section class="grid hidden" id="tab-ajustes">
    <div class="card">
      <div class="h2">âš™ï¸ Ajustes rÃ¡pidos</div>
      <div class="row">
        <button class="ghost" id="toggleNoRepeatBtn">No repetir: ON</button>
        <button class="ghost" id="toggleAlcoholBtn">Alcohol: ON</button>
        <button class="ghost" id="toggleChaosBtn">Modo: Medio</button>
      </div>

      <div class="divider"></div>

      <div class="h2">ğŸ¯ Quiz: probabilidad (pmin / pmax)</div>
      <div class="muted small">Se usa la fÃ³rmula: p = pmin + (1 - aciertos/N)Â·(pmax-pmin)</div>
      <div class="row" style="margin-top:8px">
        <label class="pill">pmin <input id="pmin" type="number" min="0" max="1" step="0.01" value="0.05" style="width:80px; margin-left:8px"></label>
        <label class="pill">pmax <input id="pmax" type="number" min="0" max="1" step="0.01" value="0.75" style="width:80px; margin-left:8px"></label>
        <button class="ghost" id="applyProbBtn">Aplicar</button>
      </div>

      <div class="divider"></div>

      <div class="h2">ğŸ² FrangÃ©lico: lÃ­mite de usos</div>
      <div class="row" style="margin-top:8px">
        <label class="pill">Max usos <input id="frMax" type="number" min="1" max="10" step="1" value="3" style="width:70px; margin-left:8px"></label>
        <button class="ghost" id="applyFrMaxBtn">Aplicar</button>
      </div>

      <div class="divider"></div>
      <div class="muted small">
        Si quieres, te lo personalizo con vuestras pruebas exactas del PDF (Calle Laurel/San Juan, nombres, etc.).
      </div>
    </div>

    <div class="card">
      <div class="h2">ğŸ§© Editar contenido</div>
      <div class="muted small">Todo vive en arrays al final del archivo (busca â€œDATAâ€). Puedes pegar vuestras preguntas y pruebas ahÃ­.</div>
      <div class="box small">
        <strong>Tip:</strong> Para el quiz del novio, usa respuestas tipo A/B/C/D para evitar discusiones.
      </div>
      <div class="divider"></div>
      <div class="small muted">
        Â¿Quieres que lo haga â€œ100% Gloriaâ€ (con FrangÃ©lico, Calle Laurel, Oscar, Masella, etc.)?  
        PÃ©game aquÃ­ las preguntas del novio (o dime â€œusa las 10 del PDFâ€) y lo dejo cerrado.
      </div>
    </div>
  </section>

</div>

<script>
/* =========================
   DATA (EDITA AQUÃ)
   ========================= */

// CARTAS: peso = probabilidad relativa (mÃ¡s alto, mÃ¡s probable)
const CARDS_BASE = [
  { text:"Fer-se una foto amb un cambrer ğŸ“¸", type:"Calle", tag:"Prova", weight:3, drink:"Si fallas: xupito" },
  { text:"Ballar amb algÃº aleatori al carrer ğŸ’ƒ", type:"Calle", tag:"Prova", weight:3, drink:"Si fallas: xupito" },
  { text:"Demanar tapes per totes amb veu de gat ğŸ±", type:"Calle", tag:"Prova", weight:2, drink:"Si fallas: xupito" },
  { text:"AbraÃ§ada a algÃº amb samarreta vermella â¤ï¸", type:"Calle", tag:"Prova", weight:2, drink:"Si fallas: xupito" },
  { text:"Signatura dâ€™un desconegut al braÃ§ âœï¸", type:"Calle", tag:"Prova", weight:2, drink:"Si fallas: xupito" },
  { text:"Cantar â€˜Al partir un beso y una florâ€™ i aconseguir 5â‚¬ ğŸ¶", type:"Calle", tag:"Show", weight:1, drink:"Si fallas: xupito" },
  { text:"Montar un limbo al carrer (com mÃ©s gent, menys beus) ğŸª©", type:"Calle", tag:"Mini-joc", weight:2, drink:"Adaptable" },
  { text:"Aconseguir que et convidin a una copa i un pintxo ğŸ·", type:"Calle", tag:"Bonus", weight:1, drink:"Si no: sorbo" },
  { text:"DeclaraciÃ³ dâ€™amor a algÃº del carrer ğŸ’Œ", type:"Calle", tag:"Prova", weight:2, drink:"Si fallas: xupito" },
  { text:"Trobar algÃº que es digui â€˜Oscarâ€™ ğŸ”", type:"Calle", tag:"Prova", weight:1, drink:"Si fallas: xupito" },

  // Cartas â€œsuaves / casaâ€
  { text:"Brindis: cada una diu un desig per la GlÃ²ria ğŸ¥‚", type:"Casa", tag:"Emotiu", weight:3, drink:"0" },
  { text:"Reto rÃ¡pido: 10s de baile sin juzgar ğŸ’¥", type:"Casa", tag:"Reto", weight:3, drink:"0" },
  { text:"La GlÃ²ria reparteix 2 sorbos (o 2 retos light) ğŸ", type:"Casa", tag:"Repartir", weight:2, drink:"Opcional" },
  { text:"Foto de equipo: pose â€˜Â¡El Ãºltimo pintxo!â€™ ğŸ“¸", type:"Casa", tag:"Foto", weight:2, drink:"0" },

  // Cartas caÃ³ticas
  { text:"Modo â€˜voz de presentadoraâ€™ durante 5 min ğŸ¤", type:"Caos", tag:"Acting", weight:1, drink:"Si rompes: sorbo" },
  { text:"Doble o nada: repite la Ãºltima carta para ganar inmunidad 1 ronda ğŸ˜ˆ", type:"Caos", tag:"Doble", weight:1, drink:"Si fallas: doble" },
];

// QUIZ DEL NOVIO (ejemplo con vuestras 10 del PDF, adaptadas a multiopciÃ³n)
// correctIndex: 0=A,1=B,2=C,3=D
const QUIZ = [
  {
    q:"Â¿DÃ³nde y cuÃ¡ndo fue el primer beso?",
    a:["Costa Breve (2015, invierno)","El Palmar (2016, verano)","Sant Quirze (2014, otoÃ±o)","Masella (2017, invierno)"],
    correctIndex:0,
    reveal:"Costa Breve, 2015 (invierno)."
  },
  {
    q:"Â¿CuÃ¡l es vuestro lugar de refugio?",
    a:["LogroÃ±o / Calle Laurel","Cerdanya o El Palmar (CÃ¡diz)","MarquÃ©s de Riscal","NYC 5th Avenue"],
    correctIndex:1,
    reveal:"Cerdanya o El Palmar (CÃ¡diz)."
  },
  {
    q:"Â¿QuÃ© disfrutÃ¡is mÃ¡s hacer como pareja?",
    a:["Salir de fiesta cada sÃ¡bado","Viajar en motorhome y estar juntos","Hacer triatlÃ³n","Cocinar sushi siempre"],
    correctIndex:1,
    reveal:"Estar juntos; viajar (motorhome) y sofÃ¡/caricias mientras ella se duerme."
  },
  {
    q:"En la uni, Â¿quiÃ©n dio el primer paso?",
    a:["Ella, con un mensaje en IG","Ã‰l, pidiendo ayuda para un trabajo de inglÃ©s","Fue una cita a ciegas","Se conocieron esquiando"],
    correctIndex:1,
    reveal:"Ã‰l hablÃ³ con ella para conseguir ayuda en un trabajo de inglÃ©s."
  },
  {
    q:"Â¿Plato preferido del otro (aprox.)?",
    a:["Paella y ramen","Buen pescado a la brasa","Pizza y hamburguesa","Solo ensaladas"],
    correctIndex:1,
    reveal:"Buen pescado (turbot/llobarro) a la brasa; en casa: pollo rebozado sin gluten."
  },
  {
    q:"Â¿Primer viaje juntos?",
    a:["Masella","El Palmar (CÃ¡diz)","ParÃ­s","LogroÃ±o"],
    correctIndex:1,
    reveal:"El Palmar (CÃ¡diz)."
  },
  {
    q:"Â¿SueÃ±o compartido ahora mismo?",
    a:["Mudarse a JapÃ³n","Familia en Sant Quirze y seguir viajando; ver auroras boreales","Comprar una bodega","Vivir en un barco"],
    correctIndex:1,
    reveal:"Familia en Sant Quirze, seguir viajando, y algÃºn dÃ­a ver auroras boreales."
  },
  {
    q:"Â¿Momento de mÃ¡s vergÃ¼enza?",
    a:["En una boda","El primer dÃ­a con Willi (nerviosismo)","En una entrevista","En una pista de esquÃ­"],
    correctIndex:1,
    reveal:"El primer dÃ­a que conociÃ³ a Willi (mÃ¡s nervios que vergÃ¼enza)."
  },
  {
    q:"Â¿Olor/gusto que recuerda al otro?",
    a:["CafÃ© y canela","Colonia (Abercrombie antes; ahora Loewe / champÃº Zig Zag)","Chocolate","Hierba cortada"],
    correctIndex:1,
    reveal:"Antes Abercrombie; ahora Loewe o champÃº Zig Zag; de ella: Carolina Herrera."
  },
  {
    q:"Â¿Costumbre extraÃ±a adorable del otro?",
    a:["Dejar todo para maÃ±ana","Ir a misa; obsesiÃ³n con la limpieza","Coleccionar piedras","Cantar Ã³pera"],
    correctIndex:1,
    reveal:"Ir a misa; y su obsesiÃ³n con la limpieza (le pone nervioso a veces)."
  },
];

// PASAPALABRA (del PDF, tal cual)
const PASAPALABRA = [
  { letter:"A", clue:"El que sents pel teu futur espÃ²s", word:"Amor" },
  { letter:"B", clue:"Estat en el que acabarÃ s avui", word:"Borratxa" },
  { letter:"C", clue:"Casos clÃ­nics dels que tant ens has parlat", word:"Cuo" },
  { letter:"D", clue:"La millor professiÃ³ del mÃ³n", word:"Dentista" },
  { letter:"E", clue:"Esport que adores i que ens ha unit", word:"EsquÃ­" },
  { letter:"F", clue:"Beguda que promocionarÃ  la teva despedida", word:"Frangelico" },
  { letter:"G", clue:"Animal que odies amb totes les teves forces", word:"Gat" },
  { letter:"H", clue:"Objecte amb el que tenim molts rÃ©cord de petites", word:"Hula hop" },
  { letter:"I", clue:"Animal que veiem de tant en tant per les pistes", word:"Isard" },
  { letter:"J", clue:"El que adores fer amb lâ€™Oscar i no pensem malamentâ€¦", word:"Jalar" },
  { letter:"K", clue:"La Biblia sexual que mai et faltarÃ ", word:"Kamasutra" },
  { letter:"L", clue:"El que fas per quadrar totes les teves clÃ­niques", word:"LogÃ­stica" },
  { letter:"M", clue:"El teu lloc refugi", word:"Masella" },
  { letter:"N", clue:"El que tindrÃ s el dia del casament", word:"Nervis" },
  { letter:"O", clue:"Lâ€™amor de la teva vida", word:"Oscar" },
  { letter:"P", clue:"Paraula que direm quan et veiem vestida de nÃºvia", word:"Preciosa" },
  { letter:"Q", clue:"AllÃ² que veus cada dia a la consulta", word:"Queixal" },
  { letter:"R", clue:"El que mai falta quan estÃ s amb nosaltres", word:"Rialles" },
  { letter:"S", clue:"Sorpresa que encara no saps que et tenim preparada", word:"Striptease" },
  { letter:"T", clue:"Personatge cÃ²mic amb el que identifiques a lâ€™Oscar", word:"TintÃ­n" },
  { letter:"U", clue:"El que us va unir a lâ€™Oscar i tu", word:"UIC" },
  { letter:"V", clue:"El que cridarem quan us veurem sortir del altar", word:"Viva los novios" },
  { letter:"W", clue:"Encara que et casis sempre seguirÃ s sent la seva nenaâ€¦", word:"Willy" },
  { letter:"X", clue:"El que obrirÃ s per celebrar-ho tot", word:"Xampany" },
  { letter:"Y", clue:"Lâ€™equilibri perfecte entre festa i bogeria", word:"Ying Yang" },
  { letter:"Z", clue:"El teu millor amic a lâ€™hora de fer corones", word:"Zirconi" },
];

// FRANGELICO DECIDE (pesos)
const FRANGELICO_BASE = [
  { text:"Chupito (o reto rÃ¡pido si sin alcohol) ğŸ¥ƒ", weight:3, alcohol:true },
  { text:"Reparte 2 sorbos / 2 retos ğŸ", weight:3, alcohol:true },
  { text:"Beben todas (light) ğŸ¥‚", weight:2, alcohol:true },
  { text:"Inmunidad 1 ronda ğŸ›¡ï¸", weight:2, alcohol:false },
  { text:"Reto absurdo: voz de gato 2 min ğŸ±", weight:2, alcohol:false },
  { text:"Foto de grupo obligatoria ğŸ“¸", weight:2, alcohol:false },
  { text:"Elige a tu â€˜escuderaâ€™ por 30 min ğŸ‘‘", weight:1, alcohol:false },
];

/* =========================
   ENGINE
   ========================= */

const state = {
  tab:"cartas",
  noRepeat:true,
  alcohol:true,
  chaos:"Medio", // Suave | Medio | CaÃ³tico
  history:[],
  deck:[],
  deckUsed:[],
  lastCard:null,

  // Quiz
  qIndex:-1,
  correct:0,
  answered:false,
  pmin:0.05,
  pmax:0.75,

  // Frangelico
  frUses:0,
  frMax:3,

  // Pasapalabra
  ppRunning:false,
  ppTime:90,
  ppLeft:90,
  ppIdx:0,
  ppPassed:0,
  ppShown:0,
  ppTimerId:null
};

function clamp(x,min,max){ return Math.max(min, Math.min(max, x)); }

function weightedPick(items){
  const total = items.reduce((s,i)=> s + (i.weight||1), 0);
  let r = Math.random() * total;
  for (const it of items){
    r -= (it.weight||1);
    if (r <= 0) return it;
  }
  return items[items.length-1];
}

function buildDeck(){
  // Ajuste de pesos por caos
  const mult = (t)=>{
    if(state.chaos==="Suave"){
      if(t==="Caos") return 0.35;
      if(t==="Calle") return 0.85;
      return 1.25;
    }
    if(state.chaos==="CaÃ³tico"){
      if(t==="Caos") return 1.7;
      if(t==="Calle") return 1.25;
      return 0.85;
    }
    return 1; // Medio
  };

  state.deck = CARDS_BASE.map(c => ({
    ...c,
    weight: Math.max(0.1, (c.weight||1) * mult(c.type))
  }));
  state.deckUsed = [];
  state.lastCard = null;
  updateDeckInfo();
}

function cardToHTML(c){
  const d = (!state.alcohol || c.drink==="0") ? "Sin alcohol" : c.drink;
  return `<div class="card" style="padding:10px">
    <div style="font-weight:900;color:var(--bottle)">${escapeHtml(c.text)}</div>
    <div class="small muted">${escapeHtml(c.type)} Â· ${escapeHtml(c.tag)} Â· ${escapeHtml(d)}</div>
  </div>`;
}

function escapeHtml(s){
  return (s??"").toString().replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/* =========================
   UI: Tabs
   ========================= */
const tabsEl = document.getElementById("tabs");
tabsEl.addEventListener("click",(e)=>{
  const btn = e.target.closest(".tabbtn");
  if(!btn) return;
  setTab(btn.dataset.tab);
});
function setTab(name){
  state.tab = name;
  document.querySelectorAll(".tabbtn").forEach(b=> b.classList.toggle("active", b.dataset.tab===name));
  document.querySelectorAll("[id^='tab-']").forEach(sec=> sec.classList.add("hidden"));
  document.getElementById(`tab-${name}`).classList.remove("hidden");
}

/* =========================
   CARTAS
   ========================= */
const deckInfo = document.getElementById("deckInfo");
const repeatInfo = document.getElementById("repeatInfo");
const alcoholInfo = document.getElementById("alcoholInfo");
const cardText = document.getElementById("cardText");
const cardTag = document.getElementById("cardTag");
const cardType = document.getElementById("cardType");
const cardDrink = document.getElementById("cardDrink");
const historyEl = document.getElementById("history");

document.getElementById("drawCardBtn").onclick = ()=>{
  if(state.noRepeat){
    if(state.deck.length===0){
      cardText.textContent = "Mazo vacÃ­o. Dale a â€˜Reset mazoâ€™.";
      return;
    }
    const picked = weightedPick(state.deck);
    // remove first matching instance
    const idx = state.deck.findIndex(x=> x.text===picked.text);
    const [c] = state.deck.splice(idx,1);
    state.deckUsed.push(c);
    showCard(c);
  }else{
    const c = weightedPick(state.deck);
    showCard(c);
  }
  updateDeckInfo();
};
document.getElementById("undoCardBtn").onclick = ()=>{
  if(!state.lastCard || state.history.length===0) return;
  const removed = state.history.pop();
  if(state.noRepeat){
    // return to deck
    state.deck.push(removed);
    state.deckUsed = state.deckUsed.filter(x=> x.text!==removed.text);
  }
  state.lastCard = state.history[state.history.length-1] || null;
  if(state.lastCard) showCard(state.lastCard, true);
  else{
    cardText.textContent = "Deshecho. Lista para la siguiente âœ¨";
    cardTag.textContent = "â€”";
    cardType.textContent = "â€”";
    cardDrink.textContent = "â€”";
  }
  renderHistory();
  updateDeckInfo();
};
document.getElementById("resetDeckBtn").onclick = ()=>{
  buildDeck();
  cardText.textContent = "Mazo reseteado. Â¡A por el pintxo!";
  cardTag.textContent = "â€”";
  cardType.textContent = "â€”";
  cardDrink.textContent = "â€”";
};
document.getElementById("clearHistoryBtn").onclick = ()=>{
  state.history = [];
  state.lastCard = null;
  renderHistory();
};
function showCard(c, silent=false){
  state.lastCard = c;
  if(!silent) state.history.push(c);
  cardText.textContent = c.text;
  cardTag.textContent = `#${c.tag}`;
  cardType.textContent = c.type;
  cardDrink.textContent = (!state.alcohol || c.drink==="0") ? "Sin alcohol" : c.drink;
  renderHistory();
}
function renderHistory(){
  historyEl.innerHTML = state.history.slice().reverse().map(cardToHTML).join("");
  if(state.history.length===0) historyEl.innerHTML = `<div class="muted small">AÃºn no hay cartas en el historial.</div>`;
}
function updateDeckInfo(){
  deckInfo.textContent = `Mazo: ${state.deck.length} cartas`;
  repeatInfo.textContent = `No repetir: ${state.noRepeat ? "ON":"OFF"}`;
  alcoholInfo.textContent = `Alcohol: ${state.alcohol ? "ON":"OFF"}`;
}

/* =========================
   QUIZ
   ========================= */
const quizProgress = document.getElementById("quizProgress");
const quizScore = document.getElementById("quizScore");
const quizQ = document.getElementById("quizQ");
const quizChoices = document.getElementById("quizChoices");
const quizFeedback = document.getElementById("quizFeedback");
const quizNextBtn = document.getElementById("quizNextBtn");

document.getElementById("quizStartBtn").onclick = ()=>{
  resetQuiz();
  state.qIndex = 0;
  renderQuiz();
};
quizNextBtn.onclick = ()=>{
  if(state.qIndex < QUIZ.length-1){
    state.qIndex++;
    state.answered = false;
    renderQuiz();
  }else{
    showQuizResult();
  }
};
document.getElementById("quizResetBtn").onclick = resetQuiz;

function resetQuiz(){
  state.qIndex = -1;
  state.correct = 0;
  state.answered = false;
  quizQ.textContent = "Pulsa â€œEmpezarâ€.";
  quizChoices.innerHTML = "";
  quizFeedback.textContent = "";
  quizNextBtn.disabled = true;
  updateQuizMeta();
  document.getElementById("answerKey").classList.add("hidden");
  document.getElementById("answerKey").innerHTML = "";
  document.getElementById("quizResult").textContent = "AÃºn no hay resultado.";
  document.getElementById("pNow").textContent = "p â€”";
}
function updateQuizMeta(){
  const total = QUIZ.length;
  const idx = state.qIndex>=0 ? state.qIndex+1 : 0;
  quizProgress.textContent = `Pregunta ${idx}/${total}`;
  quizScore.textContent = `Aciertos: ${state.correct}`;
  document.getElementById("pMinMax").textContent = `pmin ${state.pmin.toFixed(2)} / pmax ${state.pmax.toFixed(2)}`;
}
function renderQuiz(){
  const item = QUIZ[state.qIndex];
  updateQuizMeta();
  quizQ.textContent = item.q;
  quizFeedback.textContent = "";
  quizChoices.innerHTML = item.a.map((opt,i)=>`
    <button class="choice" data-i="${i}">${String.fromCharCode(65+i)}) ${escapeHtml(opt)}</button>
  `).join("");
  quizNextBtn.disabled = true;

  quizChoices.querySelectorAll(".choice").forEach(btn=>{
    btn.onclick = ()=>{
      if(state.answered) return;
      state.answered = true;
      const pick = Number(btn.dataset.i);
      const correct = item.correctIndex;
      if(pick === correct) state.correct++;
      quizChoices.querySelectorAll(".choice").forEach((b,ii)=>{
        b.classList.toggle("correct", ii===correct);
        b.classList.toggle("wrong", ii===pick && pick!==correct);
      });
      quizFeedback.textContent = `Respuesta del novio: ${item.reveal}`;
      updateQuizMeta();
      quizNextBtn.disabled = false;
      if(state.qIndex === QUIZ.length-1) quizNextBtn.textContent = "Ver resultado";
      else quizNextBtn.textContent = "Siguiente";
    };
  });
}

function currentPunishProb(){
  const N = QUIZ.length;
  const k = state.correct;
  const p = state.pmin + (1 - (k / N)) * (state.pmax - state.pmin);
  return clamp(p, 0, 1);
}
function showQuizResult(){
  updateQuizMeta();
  const p = currentPunishProb();
  document.getElementById("pNow").textContent = `p ${p.toFixed(2)}`;
  const msg = `Final: ${state.correct}/${QUIZ.length} aciertos â†’ prob. castigo â‰ˆ ${(p*100).toFixed(0)}%`;
  document.getElementById("quizResult").textContent = msg;
  quizNextBtn.disabled = true;
}

document.getElementById("rollPunishBtn").onclick = ()=>{
  if(state.qIndex < 0){
    document.getElementById("quizResult").textContent = "Primero haz el quiz ğŸ™‚";
    return;
  }
  const p = currentPunishProb();
  const r = Math.random();
  const toc = r < p;
  const punishment = state.alcohol ? "CHUPITO" : "RETO RÃPIDO";
  document.getElementById("quizResult").textContent =
    toc ? `ğŸ”¥ TOCA ${punishment} (r=${r.toFixed(2)} < p=${p.toFixed(2)})`
        : `ğŸ›¡ï¸ NO TOCA (r=${r.toFixed(2)} â‰¥ p=${p.toFixed(2)})`;
  document.getElementById("pNow").textContent = `p ${p.toFixed(2)}`;
};

document.getElementById("revealAnswersBtn").onclick = ()=>{
  const key = document.getElementById("answerKey");
  key.classList.toggle("hidden");
  if(!key.classList.contains("hidden")){
    key.innerHTML = QUIZ.map((it,idx)=>{
      const correct = it.a[it.correctIndex];
      return `<div style="margin-bottom:8px"><strong>${idx+1}.</strong> ${escapeHtml(it.q)}<br><span class="muted">Clave: ${escapeHtml(correct)}.</span></div>`;
    }).join("");
  }
};

/* =========================
   FRANGELICO
   ========================= */
const frUses = document.getElementById("frUses");
const frText = document.getElementById("frText");
const frNoAlcohol = document.getElementById("frNoAlcohol");

function updateFrMeta(){
  frUses.textContent = `Usos: ${state.frUses}/${state.frMax}`;
  frNoAlcohol.textContent = `Modo sin alcohol: ${state.alcohol ? "OFF":"ON"}`;
}
document.getElementById("frRollBtn").onclick = ()=>{
  if(state.frUses >= state.frMax){
    frText.textContent = "ğŸš« LÃ­mite alcanzado. Guardad algo de dignidad para el brunch ğŸ˜‡";
    return;
  }
  state.frUses++;
  const pick = weightedPick(FRANGELICO_BASE);
  if(!state.alcohol && pick.alcohol){
    frText.textContent = "âœ¨ Reto rÃ¡pido (sin alcohol): 10s de baile + selfie grupal ğŸ“¸";
  }else{
    frText.textContent = pick.text;
  }
  updateFrMeta();
};
document.getElementById("frResetBtn").onclick = ()=>{
  state.frUses = 0;
  frText.textContent = "Â¿Nos dejamos llevarâ€¦?";
  updateFrMeta();
};

/* =========================
   PASAPALABRA
   ========================= */
const ppTimer = document.getElementById("ppTimer");
const ppIndex = document.getElementById("ppIndex");
const ppClue = document.getElementById("ppClue");
const ppWord = document.getElementById("ppWord");
const ppPassed = document.getElementById("ppPassed");
const ppShown = document.getElementById("ppShown");

function renderPP(){
  const it = PASAPALABRA[state.ppIdx];
  ppTimer.textContent = `Tiempo: ${state.ppLeft}s`;
  ppIndex.textContent = `Letra: ${it.letter}`;
  ppClue.textContent = `${it.letter} â€” ${it.clue}`;
  ppPassed.textContent = `Pasadas: ${state.ppPassed}`;
  ppShown.textContent = `Reveladas: ${state.ppShown}`;
}
function stopPP(){
  state.ppRunning = false;
  if(state.ppTimerId) clearInterval(state.ppTimerId);
  state.ppTimerId = null;
  document.getElementById("ppPassBtn").disabled = true;
  document.getElementById("ppShowBtn").disabled = true;
}
document.getElementById("ppStartBtn").onclick = ()=>{
  if(state.ppRunning) return;
  state.ppRunning = true;
  document.getElementById("ppPassBtn").disabled = false;
  document.getElementById("ppShowBtn").disabled = false;

  state.ppTimerId = setInterval(()=>{
    state.ppLeft--;
    ppTimer.textContent = `Tiempo: ${state.ppLeft}s`;
    if(state.ppLeft<=0){
      stopPP();
      ppClue.textContent = "â±ï¸ Tiempo. Brindis final y se acabÃ³.";
      ppWord.textContent = "";
    }
  }, 1000);
};
document.getElementById("ppPassBtn").onclick = ()=>{
  state.ppPassed++;
  state.ppIdx = (state.ppIdx + 1) % PASAPALABRA.length;
  ppWord.textContent = "";
  renderPP();
};
document.getElementById("ppShowBtn").onclick = ()=>{
  const it = PASAPALABRA[state.ppIdx];
  state.ppShown++;
  ppWord.textContent = `Palabra: ${it.word}`;
  renderPP();
};
document.getElementById("ppResetBtn").onclick = ()=>{
  stopPP();
  state.ppTime = 90;
  state.ppLeft = 90;
  state.ppIdx = 0;
  state.ppPassed = 0;
  state.ppShown = 0;
  ppClue.textContent = "â€”";
  ppWord.textContent = "";
  renderPP();
};

/* =========================
   AJUSTES
   ========================= */
const toggleNoRepeatBtn = document.getElementById("toggleNoRepeatBtn");
const toggleAlcoholBtn = document.getElementById("toggleAlcoholBtn");
const toggleChaosBtn = document.getElementById("toggleChaosBtn");

toggleNoRepeatBtn.onclick = ()=>{
  state.noRepeat = !state.noRepeat;
  toggleNoRepeatBtn.textContent = `No repetir: ${state.noRepeat ? "ON":"OFF"}`;
  updateDeckInfo();
  buildDeck();
};
toggleAlcoholBtn.onclick = ()=>{
  state.alcohol = !state.alcohol;
  toggleAlcoholBtn.textContent = `Alcohol: ${state.alcohol ? "ON":"OFF"}`;
  updateDeckInfo();
  updateFrMeta();
};
toggleChaosBtn.onclick = ()=>{
  state.chaos = (state.chaos==="Suave") ? "Medio" : (state.chaos==="Medio" ? "CaÃ³tico" : "Suave");
  toggleChaosBtn.textContent = `Modo: ${state.chaos}`;
  buildDeck();
};

document.getElementById("applyProbBtn").onclick = ()=>{
  const pmin = Number(document.getElementById("pmin").value);
  const pmax = Number(document.getElementById("pmax").value);
  state.pmin = clamp(pmin,0,1);
  state.pmax = clamp(pmax,0,1);
  if(state.pmax < state.pmin){
    const tmp = state.pmin; state.pmin = state.pmax; state.pmax = tmp;
  }
  updateQuizMeta();
  showQuizResult();
};
document.getElementById("applyFrMaxBtn").onclick = ()=>{
  state.frMax = clamp(Number(document.getElementById("frMax").value),1,10);
  updateFrMeta();
};

/* =========================
   INIT
   ========================= */
buildDeck();
renderHistory();
updateQuizMeta();
updateFrMeta();
renderPP();
setTab("cartas");
</script>
</body>
</html>
